<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
	<title>Homebrew Header Swapper</title>
	<style>
		body {
			background-color: #222;
		}
		.container {
            background-color: #222;
            border: 2px gainsboro solid;
            width: 30%;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            border-radius: 5px;
            color: gainsboro;
            text-align: center;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            transition: 0.5s ease-in-out;
            border-radius: 5px;
        }
        .custom-file-upload:hover {
            background-color: #333;
        }
        .outer {
            display: table;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
        
        .middle {
            display: table-cell;
            vertical-align: middle;
        }

        @media (max-width: 1200px) {
            .container {
                width: 50%;
            }
        }

        @media (max-width: 1000px) {
            .container {
                width: 80%;
            }
        }
	</style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body class="bg-dark">
    <div class="outer">
        <div class="middle">
            <div class="container">
                <h1>Homebrew Header Swapper</h1>
                <label for="rom" class="custom-file-upload">
                    Upload ROM
                </label>
                <input id="rom" type="file" accept=".z64"/>
                <div id="result" class="card bg-dark pb-3 px-3 mt-2 border-1" hidden>
                    <div id="detection_result" class="mb-2 mt-1" style="color:white"></div>
                    <div class="form-floating mb-2" id="game_list_wrapper">
                        <select class="form-select" id="game_list" aria-label="Floating label select example">
                           <option value="dk64_us">Donkey Kong 64 (US)</option>
                            <option value="tooie_us">Banjo-Tooie (US)</option>
                            <option value="add_header" hidden></option>
                        </select>
                        <label for="game_list">Selected Game</label>
                    </div>
                    <button class="btn btn-success" id="download_button">

                    </button>
                </div>
            </div>
        </div>
    </div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript">
        function checkHomebrew(f) {
            if ((f[0x3C] == 0x45) && (f[0x3D] == 0x44) && (f[0x3F] == 0x20)) {
                return true;
            }
            return false;
        }
        let file_bytes = null;

        function writeToFile(f, name) {
			var write_bytes = new Uint8Array(f.length);
			f.forEach((item,index) => {write_bytes[index] = item})
			var saveByteArray = (function () {
				var a = document.createElement("a");
				document.body.appendChild(a);
				a.style = "display:none";
				return function (data, name) {
					var blob = new Blob(data, {type: "octet/stream"}),
					url = window.URL.createObjectURL(blob);
					a.href = url;
					a.download = name;
					a.click();
					a.remove();
				};
			}())
			saveByteArray([write_bytes],name)
		}

        function setHeader(output) {
            if (output == "add_header") {
                file_bytes[0x3C] = 0x45;
                file_bytes[0x3D] = 0x44;
                file_bytes[0x3F] = 0x20;
            } else if (output == "dk64_us") {
                file_bytes[0x3C] = 0x44;
                file_bytes[0x3D] = 0x4F;
                file_bytes[0x3F] = 0x00;
            } else if (output == "tooie_us") {
                file_bytes[0x3C] = 0x42;
                file_bytes[0x3D] = 0x37;
                file_bytes[0x3F] = 0x00;
            }
            writeToFile(file_bytes, document.getElementById("rom").value.replace(/.*[\/\\]/, ''));
        }

        document.getElementById("download_button").addEventListener("click", () => {
            setHeader(document.getElementById("game_list").value);
        });

		document.getElementById("rom").addEventListener("change", function() {
			var fr = new FileReader();
			fr.onload = function() {
				var data = fr.result;
				setup_data = fr.result;
			    var array = new Uint8Array(data);
			    file_bytes = array.slice()
                const is_homebrew = checkHomebrew(file_bytes)
                document.getElementById("result").removeAttribute("hidden");
                // Detection
                const detected = is_homebrew ? 'Homebrew Header' : 'Vanilla Header';
                document.getElementById("detection_result").innerText = `Detected: ${detected}`;
                const button_text = is_homebrew ? 'Remove Header' : 'Add Header';
                document.getElementById("download_button").innerText = button_text;
                // Hiding unimportant things
                if (is_homebrew) {
                    document.getElementById("game_list_wrapper").removeAttribute("hidden");
                    document.getElementById("game_list").value = "dk64_us";
                } else {
                    document.getElementById("game_list_wrapper").setAttribute("hidden", "hidden");
                    document.getElementById("game_list").value = "add_header";
                }
			};
			fr.readAsArrayBuffer(document.getElementById("rom").files[0]);
        })
	</script>
</body>
</html>